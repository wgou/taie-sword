<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简单集成示例</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        button { padding: 10px 20px; margin: 5px; }
        input { padding: 8px; margin: 5px; width: 200px; }
        #messages { border: 1px solid #ccc; height: 200px; overflow-y: auto; padding: 10px; margin: 10px 0; }
        .status { padding: 5px; margin: 5px 0; font-weight: bold; }
        .connected { color: green; }
        .disconnected { color: red; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔌 WebRTC 简单集成示例</h1>
        
        <!-- 连接控制 -->
        <div>
            <input type="text" id="room" placeholder="房间ID" value="test123">
            <button onclick="connect()">连接</button>
            <button onclick="disconnect()">断开</button>
        </div>
        
        <!-- 状态显示 -->
        <div id="status" class="status disconnected">状态: 未连接</div>
        <div id="mode" class="status">模式: 未知</div>
        
        <!-- 消息区域 -->
        <div id="messages"></div>
        
        <!-- 消息发送 -->
        <div>
            <input type="text" id="messageText" placeholder="输入消息">
            <button onclick="sendMessage()">发送</button>
        </div>
        
        <!-- 文件发送 -->
        <div>
            <input type="file" id="fileInput">
            <button onclick="sendFile()">发送文件</button>
        </div>
        
        <!-- P2P控制 -->
        <div>
            <button onclick="initiateP2P()">发起P2P连接</button>
            <button onclick="toggleAutoP2P()">切换自动P2P</button>
        </div>
    </div>

    <!-- 引入 WebRTC 客户端模块 -->
    <script src="webrtc-client.js"></script>
    
    <script>
        // 全局变量
        let webrtcClient = null;
        
        // 初始化 WebRTC 客户端
        function initWebRTC() {
            webrtcClient = new WebRTCClient({
                serverUrl: 'ws://127.0.0.1:9001',
                debug: true,
                autoInitiateP2P: false, // 默认手动控制
                callbacks: {
                    onConnected: () => {
                        updateStatus('已连接', 'connected');
                        addMessage('✅ 连接成功');
                    },
                    onDisconnected: () => {
                        updateStatus('未连接', 'disconnected');
                        updateMode('未连接');
                        addMessage('❌ 连接断开');
                    },
                    onUserJoined: (userId) => {
                        addMessage(`👤 用户 ${userId} 加入`);
                    },
                    onUserLeft: (userId) => {
                        addMessage(`👋 用户 ${userId} 离开`);
                    },
                    onMessageReceived: (sender, message, isP2P) => {
                        const type = isP2P ? '🔗 P2P' : '🌐 转发';
                        addMessage(`${type} ${sender}: ${message}`);
                    },
                    onBinaryDataReceived: (sender, data, isP2P) => {
                        const type = isP2P ? '🔗 P2P' : '🌐 转发';
                        const size = data.byteLength || data.size || 0;
                        addMessage(`${type} ${sender} 发送文件 (${formatSize(size)})`);
                    },
                    onConnectionStateChanged: (state) => {
                        updateMode(state);
                    },
                    onError: (error) => {
                        addMessage(`❌ 错误: ${error}`);
                    }
                }
            });
        }
        
        // 连接函数
        async function connect() {
            const roomId = document.getElementById('room').value.trim();
            if (!roomId) {
                alert('请输入房间ID');
                return;
            }
            
            if (!webrtcClient) {
                initWebRTC();
            }
            
            try {
                await webrtcClient.connect(roomId);
            } catch (error) {
                addMessage(`❌ 连接失败: ${error.message}`);
            }
        }
        
        // 断开连接
        function disconnect() {
            if (webrtcClient) {
                webrtcClient.disconnect();
            }
        }
        
        // 发送消息
        function sendMessage() {
            const messageText = document.getElementById('messageText');
            const message = messageText.value.trim();
            
            if (!message || !webrtcClient) return;
            
            if (webrtcClient.sendMessage(message)) {
                addMessage(`💬 我: ${message}`);
                messageText.value = '';
            } else {
                addMessage('❌ 消息发送失败');
            }
        }
        
        // 发送文件
        function sendFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file || !webrtcClient) return;
            
            if (webrtcClient.sendBinaryData(file)) {
                addMessage(`📎 我发送文件: ${file.name} (${formatSize(file.size)})`);
            } else {
                addMessage('❌ 文件发送失败');
            }
        }
        
        // 更新状态显示
        function updateStatus(text, className) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = `状态: ${text}`;
            statusEl.className = `status ${className}`;
        }
        
        function updateMode(mode) {
            document.getElementById('mode').textContent = `模式: ${mode}`;
        }
        
        // 添加消息到显示区域
        function addMessage(message) {
            const messagesEl = document.getElementById('messages');
            const time = new Date().toLocaleTimeString();
            const messageEl = document.createElement('div');
            messageEl.innerHTML = `<small>[${time}]</small> ${message}`;
            messagesEl.appendChild(messageEl);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }
        
        // 格式化文件大小
        function formatSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
        
        // 回车发送消息
        document.getElementById('messageText').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // 新增P2P控制功能
        async function initiateP2P() {
            if (!webrtcClient || !webrtcClient.canInitiateP2P()) {
                addMessage('❌ 当前无法发起P2P连接');
                return;
            }
            
            addMessage('🚀 手动发起P2P连接...');
            const success = await webrtcClient.manualInitiateP2P();
            if (success) {
                addMessage('✅ P2P连接发起成功');
            } else {
                addMessage('❌ P2P连接发起失败');
            }
        }
        
        function toggleAutoP2P() {
            if (!webrtcClient) return;
            
            const currentState = webrtcClient.getConnectionState().autoInitiateP2P;
            const newState = !currentState;
            webrtcClient.setAutoInitiateP2P(newState);
            addMessage(`🔧 自动P2P模式: ${newState ? '启用' : '禁用'}`);
        }
        
        // 页面加载完成提示
        document.addEventListener('DOMContentLoaded', () => {
            addMessage('📱 页面已加载，请输入房间ID并连接');
            addMessage('💡 提示: 连接后可以手动发起P2P连接或启用自动模式');
        });
    </script>
</body>
</html>
