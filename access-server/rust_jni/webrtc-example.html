<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC客户端使用示例</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status {
            padding: 8px;
            border-radius: 4px;
            margin: 5px 0;
            font-weight: bold;
        }
        .status.connected { background: #d4edda; color: #155724; }
        .status.disconnected { background: #f8d7da; color: #721c24; }
        .input-group {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        input[type="text"] {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            padding: 8px 16px;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .messages {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            background: #fafafa;
        }
        .debug-info {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 WebRTC客户端使用示例</h1>
        
        <div class="input-group">
            <input type="text" id="roomId" placeholder="房间ID" value="room123">
            <button id="connectBtn">连接</button>
            <button id="disconnectBtn" disabled>断开</button>
        </div>
        
        <div class="status disconnected" id="status">状态: 未连接</div>
        <div class="status disconnected" id="chatMode">模式: 未连接</div>
        
        <div class="messages" id="messages"></div>
        
        <div class="input-group">
            <input type="text" id="messageInput" placeholder="输入消息..." disabled>
            <button id="sendBtn" disabled>发送文本</button>
            <button id="debugBtn" disabled>调试检查</button>
        </div>
        
        <div class="input-group">
            <button id="initiateP2PBtn" disabled>手动发起P2P</button>
            <button id="reconnectP2PBtn" disabled>重新连接P2P</button>
            <button id="toggleAutoP2PBtn" disabled>切换自动P2P</button>
            <button id="p2pDetailsBtn" disabled>P2P详情</button>
        </div>
        
        <div class="input-group">
            <input type="file" id="fileInput" disabled>
            <button id="sendFileBtn" disabled>发送文件</button>
        </div>
        
        <h3>调试信息</h3>
        <div class="debug-info" id="debugInfo">等待连接...</div>
    </div>

    <!-- 引入WebRTC客户端模块 -->
    <script src="webrtc-client.js"></script>
    
    <script>
        class WebRTCDemo {
            constructor() {
                this.webrtcClient = null;
                this.setupUI();
                this.initWebRTC();
            }
            
            setupUI() {
                // 获取DOM元素
                this.elements = {
                    roomId: document.getElementById('roomId'),
                    connectBtn: document.getElementById('connectBtn'),
                    disconnectBtn: document.getElementById('disconnectBtn'),
                    status: document.getElementById('status'),
                    chatMode: document.getElementById('chatMode'),
                    messages: document.getElementById('messages'),
                    messageInput: document.getElementById('messageInput'),
                    sendBtn: document.getElementById('sendBtn'),
                    debugBtn: document.getElementById('debugBtn'),
                    fileInput: document.getElementById('fileInput'),
                    sendFileBtn: document.getElementById('sendFileBtn'),
                    debugInfo: document.getElementById('debugInfo')
                };
                
                // 绑定事件
                this.elements.connectBtn.addEventListener('click', () => this.connect());
                this.elements.disconnectBtn.addEventListener('click', () => this.disconnect());
                this.elements.sendBtn.addEventListener('click', () => this.sendMessage());
                this.elements.debugBtn.addEventListener('click', () => this.runDebugCheck());
                this.elements.sendFileBtn.addEventListener('click', () => this.sendFile());
                
                // 新增的P2P控制按钮事件
                document.getElementById('initiateP2PBtn').addEventListener('click', () => this.initiateP2P());
                document.getElementById('reconnectP2PBtn').addEventListener('click', () => this.reconnectP2P());
                document.getElementById('toggleAutoP2PBtn').addEventListener('click', () => this.toggleAutoP2P());
                document.getElementById('p2pDetailsBtn').addEventListener('click', () => this.showP2PDetails());
                
                this.elements.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.sendMessage();
                    }
                });
            }
            
            initWebRTC() {
                // 创建WebRTC客户端实例
                this.webrtcClient = new WebRTCClient({
                    serverUrl: 'ws://127.0.0.1:9001',
                    debug: true,
                    autoInitiateP2P: false, // 默认不自动发起，可手动控制
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ],
                    callbacks: {
                        onConnected: () => {
                            this.updateStatus('已连接到服务器', 'connected');
                            this.setUIConnected(true);
                        },
                        onDisconnected: () => {
                            this.updateStatus('未连接', 'disconnected');
                            this.updateChatMode('未连接');
                            this.setUIConnected(false);
                        },
                        onUserJoined: (userId) => {
                            this.addMessage(`用户 ${userId} 加入了房间`, 'system');
                        },
                        onUserLeft: (userId) => {
                            this.addMessage(`用户 ${userId} 离开了房间`, 'system');
                        },
                        onMessageReceived: (senderId, message, isP2P) => {
                            const type = isP2P ? '[P2P]' : '[转发]';
                            this.addMessage(`${type} ${senderId}: ${message}`, 'peer');
                        },
                        onBinaryDataReceived: (senderId, data, isP2P) => {
                            const type = isP2P ? '[P2P]' : '[转发]';
                            const size = data.byteLength || data.size || 0;
                            this.addMessage(`${type} ${senderId} 发送了文件 (${size} 字节)`, 'peer');
                            
                            // 如果是图片，尝试显示
                            if (data instanceof Blob && data.type.startsWith('image/')) {
                                this.displayImage(data);
                            }
                        },
                        onConnectionStateChanged: (state) => {
                            this.updateChatMode(state);
                        },
                        onError: (error) => {
                            this.addMessage(`错误: ${error}`, 'error');
                        },
                        onDebug: (debugMessage) => {
                            this.updateDebugInfo(debugMessage);
                        }
                    }
                });
            }
            
            async connect() {
                const roomId = this.elements.roomId.value.trim();
                if (!roomId) {
                    alert('请输入房间ID');
                    return;
                }
                
                try {
                    this.addMessage('正在连接服务器...', 'system');
                    await this.webrtcClient.connect(roomId);
                    this.addMessage('连接成功！', 'system');
                } catch (error) {
                    this.addMessage(`连接失败: ${error.message}`, 'error');
                }
            }
            
            disconnect() {
                this.webrtcClient.disconnect();
                this.addMessage('已断开连接', 'system');
            }
            
            sendMessage() {
                const message = this.elements.messageInput.value.trim();
                if (!message) return;
                
                if (this.webrtcClient.sendMessage(message)) {
                    this.addMessage(`我: ${message}`, 'user');
                    this.elements.messageInput.value = '';
                } else {
                    this.addMessage('发送失败', 'error');
                }
            }
            
            sendFile() {
                const file = this.elements.fileInput.files[0];
                if (!file) {
                    alert('请选择文件');
                    return;
                }
                
                if (this.webrtcClient.sendBinaryData(file)) {
                    this.addMessage(`我发送了文件: ${file.name} (${file.size} 字节)`, 'user');
                } else {
                    this.addMessage('文件发送失败', 'error');
                }
            }
            
            runDebugCheck() {
                const debugInfo = this.webrtcClient.runDebugCheck();
                console.log('调试信息:', debugInfo);
            }
            
            // 新增的P2P控制方法
            async initiateP2P() {
                if (!this.webrtcClient.canInitiateP2P()) {
                    this.addMessage('❌ 当前无法发起P2P连接', 'error');
                    return;
                }
                
                this.addMessage('🚀 手动发起P2P连接...', 'system');
                const success = await this.webrtcClient.manualInitiateP2P();
                if (success) {
                    this.addMessage('✅ P2P连接发起成功', 'system');
                } else {
                    this.addMessage('❌ P2P连接发起失败', 'error');
                }
            }
            
            async reconnectP2P() {
                this.addMessage('🔄 重新建立P2P连接...', 'system');
                const success = await this.webrtcClient.forceReconnectP2P();
                if (success) {
                    this.addMessage('✅ P2P重连发起成功', 'system');
                } else {
                    this.addMessage('❌ P2P重连失败', 'error');
                }
            }
            
            toggleAutoP2P() {
                const currentState = this.webrtcClient.getConnectionState().autoInitiateP2P;
                const newState = !currentState;
                this.webrtcClient.setAutoInitiateP2P(newState);
                this.addMessage(`🔧 自动P2P模式: ${newState ? '启用' : '禁用'}`, 'system');
                
                // 更新按钮文字
                const btn = document.getElementById('toggleAutoP2PBtn');
                btn.textContent = newState ? '禁用自动P2P' : '启用自动P2P';
            }
            
            showP2PDetails() {
                const details = this.webrtcClient.getP2PConnectionDetails();
                const connectionState = this.webrtcClient.getConnectionState();
                
                const detailsText = [
                    `📊 P2P连接详情:`,
                    `• 数据通道: ${details.hasDataChannel ? '存在' : '无'} (${details.dataChannelState || 'N/A'})`,
                    `• 对等连接: ${details.peerConnectionState || 'N/A'}`,
                    `• ICE连接: ${details.iceConnectionState || 'N/A'}`,
                    `• ICE收集: ${details.iceGatheringState || 'N/A'}`,
                    `• 信令状态: ${details.signalingState || 'N/A'}`,
                    `• 发起方: ${details.isInitiator ? '是' : '否'}`,
                    `• 已发送Offer: ${details.hasSentOffer ? '是' : '否'}`,
                    `• 已收到Offer: ${details.hasReceivedOffer ? '是' : '否'}`,
                    `• 自动P2P: ${connectionState.autoInitiateP2P ? '启用' : '禁用'}`,
                    `• 可发起P2P: ${connectionState.canInitiateP2P ? '是' : '否'}`
                ].join('\n');
                
                this.addMessage(detailsText.replace(/\n/g, '<br>'), 'system');
                console.log('P2P详情:', details, connectionState);
            }
            
            addMessage(text, type) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                const timestamp = new Date().toLocaleTimeString();
                messageDiv.innerHTML = `<small>[${timestamp}]</small> ${text}`;
                
                // 设置不同类型消息的样式
                switch (type) {
                    case 'system':
                        messageDiv.style.color = '#1565c0';
                        messageDiv.style.background = '#e3f2fd';
                        break;
                    case 'user':
                        messageDiv.style.color = '#2e7d32';
                        messageDiv.style.background = '#e8f5e8';
                        messageDiv.style.textAlign = 'right';
                        break;
                    case 'peer':
                        messageDiv.style.color = '#ef6c00';
                        messageDiv.style.background = '#fff3e0';
                        break;
                    case 'error':
                        messageDiv.style.color = '#d32f2f';
                        messageDiv.style.background = '#ffebee';
                        break;
                }
                
                messageDiv.style.margin = '3px 0';
                messageDiv.style.padding = '3px 8px';
                messageDiv.style.borderRadius = '3px';
                messageDiv.style.fontSize = '12px';
                
                this.elements.messages.appendChild(messageDiv);
                this.elements.messages.scrollTop = this.elements.messages.scrollHeight;
            }
            
            updateStatus(text, className) {
                this.elements.status.textContent = `状态: ${text}`;
                this.elements.status.className = `status ${className}`;
            }
            
            updateChatMode(mode) {
                this.elements.chatMode.textContent = `模式: ${mode}`;
            }
            
            updateDebugInfo(message) {
                const debugLog = this.webrtcClient.getDebugLog(20);
                this.elements.debugInfo.innerHTML = debugLog.join('<br>');
                this.elements.debugInfo.scrollTop = this.elements.debugInfo.scrollHeight;
            }
            
            setUIConnected(connected) {
                this.elements.disconnectBtn.disabled = !connected;
                this.elements.messageInput.disabled = !connected;
                this.elements.sendBtn.disabled = !connected;
                this.elements.debugBtn.disabled = !connected;
                this.elements.fileInput.disabled = !connected;
                this.elements.sendFileBtn.disabled = !connected;
                this.elements.connectBtn.disabled = connected;
                this.elements.roomId.disabled = connected;
                
                // 新增的P2P控制按钮
                document.getElementById('initiateP2PBtn').disabled = !connected;
                document.getElementById('reconnectP2PBtn').disabled = !connected;
                document.getElementById('toggleAutoP2PBtn').disabled = !connected;
                document.getElementById('p2pDetailsBtn').disabled = !connected;
                
                // 初始化自动P2P按钮文字
                if (connected && this.webrtcClient) {
                    const autoP2P = this.webrtcClient.getConnectionState().autoInitiateP2P;
                    document.getElementById('toggleAutoP2PBtn').textContent = autoP2P ? '禁用自动P2P' : '启用自动P2P';
                }
            }
            
            displayImage(imageBlob) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(imageBlob);
                img.style.maxWidth = '200px';
                img.style.maxHeight = '200px';
                img.style.border = '1px solid #ddd';
                img.style.borderRadius = '4px';
                img.style.margin = '5px 0';
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message peer';
                messageDiv.appendChild(img);
                
                this.elements.messages.appendChild(messageDiv);
                this.elements.messages.scrollTop = this.elements.messages.scrollHeight;
            }
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            new WebRTCDemo();
        });
    </script>
</body>
</html>
